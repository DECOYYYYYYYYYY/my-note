# 计算机网络

## 引入

从浏览器输入URL到看见页面发生了什么：

1. 解析URL并生成HTTP请求
2. DNS域名解析
3. 委托协议栈发送消息
4. 发起TCP连接（三次握手）
5. HTTP发起请求
6. 服务器处理请求
7. 渲染页面：构建DOM树
8. 关闭TCP连接（四次挥手）

客户端与服务端的即时通讯：

- 短轮询：浏览器每隔一段时间向服务端发送http请求，若有数据更新，则响应。严重浪费资源
- 长轮询：客户端向服务端发送请求，服务端不直接进行响应，将请求挂起，有更新再响应。仍然造成资源浪费
- SSE：基于http协议，服务器向客户端声明，发送流信息，节约了资源
- WebSocket：允许双向通信

## 基本概念

### URL

统一资源定位符。

标准格式：`protocol://[userinfo@]host[:port][/path][?query][#fragment]`

- protocol：通信协议
- userinfo：格式为`user:password`，已弃用
- host：主机（域名）
- port：端口号，http默认端口为80，https默认为443
- path：路径，由任意个/分隔，开头的/表示根目录
  - 不以 / 结尾，会先将路径当做指向文件处理，若找不到该文件。再将路径当做指向目录处理
  - 以 / 结尾，表示访问该目录下的默认文件【一般为index.html或default.htm】
  - 路径省略不写，表示访问根目录下的默认文件
- query：参数，键值对形式，`?参数1=值1&参数2=值2`
- fragment：锚点，#开始到最后，常见于链接锚点

### 同源策略

> 两个URL协议、主机（域名）、端口号必须完全相同。违背同源策略就是跨域，默认禁止跨域读写。跨域是浏览器拦截了返回数据，而非服务器

跨域解决方案：

- JSONP：非官方的跨域解决方案，利用script标签可跨域访问脚本的特性，只支持get请求。
  1. 创建自定义函数，用于处理返回的数据
  2. 动态创建一个script标签，设置src属性为接口地址，并附上callback参数，值为自定义函数名
  3. 服务端将数据传入自定义函数的参数
  4. 前端的该函数会被调用，其参数来自服务端
- CORS：官方的跨域解决方案，支持get和post
  - 设置响应头`Access-Control-Allow-Origin` 值为 `*`
    - 值为允许的域名，*表示所有网页

## HTTP协议

> HTTP协议，hypertext transport protocol，超文本传输协议，规定了浏览器和万维网服务器之间互相通信的规则约定

### 状态码

- `1**`：信息，服务器收到请求，需要请求者继续执行操作
- `2**`：成功，操作被成功接收并处理
  - `200`：OK
- `3**`：重定向，需要进一步的操作以完成请求
  - `301`：请求的资源被永久移动到新的URI
  - `302`：临时移动
  - `303`：查看其他地址
  - `304`：所请求的资源未修改，服务器返回此状态码时，不会返回任何资源，浏览器会使用缓存
  - `307`：临时重定向
- `4**`：客户端错误，请求包含语法错误或无法完成请求
  - `400`：客户端请求语法错误
  - `401`：要求用户的身份认证
  - `403`：服务器拒绝请求
  - `404`：服务器无法找到资源
  - `408`：服务端等待客户端发送的请求时间过长，超时
- `5**`：服务端错误，服务器在处理请求的过程中发生了错误
  - `500`：服务器内部错误，无法完成请求
  - `501`：服务器不支持请求的功能
  - `502`：网关或代理服务器尝试执行请求时，从远程服务器接收到了一个无效响应

### 请求

请求报文：

- 请求行：格式为`"请求方法 URL 协议版本 换行符"`
- 请求头：键值对形式，说明请求体类型。常用的请求头有：
  - `Accept: text/html,image/*`：浏览器能处理的内容类型
  - `Accept-Charset: ISO-8859-1`：浏览器能显示的字符集
  - `Accept-Encoding: gzip,compress`：浏览器能处理的压缩编码
  - `Accept-Language: en-us,zh-cn`：浏览器的语言环境
  - `Connection: close/Keep-Alive`：请求完成后断开还是保持连接
  - `Cookie`：当前页面设置的任何Cookie
  - `Date: Tue, 11 Jul 2000 18:23:51 GMT` 请求的时间
  - `Host: www.it315.org:80`：浏览器需要访问的主机
  - `Referer: http://www.it315.org/index.jsp`：客户机是从那个页面来的（反盗链）
  - `User-Agent: Mozilla/4.0 (compatible; MSIE 5.5; Windows NT 5.0)`：浏览器内核
  - `If-Modified-Since: Tue, 11 Jul 2000 18:23:51 GMT` 缓存数据的事件
- 空行
- 请求体

传递参数：

- url直接传递（GET请求）：在url的query参数中传递
- 请求体传递（POST请求）：将参数放入请求体中

常见的请求方法：

- GET：向服务器获取数据
- POST：将实体提交到指定资源
  - GET请求与POST请求的区别：
    - GET请求是一个幂等（多次操作是否对结果没有影响）的请求，POST请求不是
    - 浏览器一般会对GET请求缓存，但一般不对POST请求缓存
    - GET请求的请求体一般为空，POST请求的请求体一般为向服务器发送的数据
    - GET请求把参数放入url传递，POST可将参数放入请求体。GET更快，POST更安全
    - GET提交的参数受限于url长度；POST可以提交大量数据，支持更多的数据类型，受服务器限制
- PUT：上传文件，更新数据
- DELETE：删除服务器上的对象
- HEAD：获取报文首部，相比GET不返回报文主体部分
- OPTIONS：询问支持的请求方法，检查访问权限，如跨域权限
- CONNECT：要求在与代理服务器通信时建立隧道，使用隧道进行TCP通信
- TRACE：回显服务器收到的请求，用于测试或诊断

### 响应

响应报文：

- 响应行：`"协议版本 状态码 状态码原因短语"`
- 响应头：键值对形式，对响应体的描述，常用的响应头有：
  - `Connection: close/Keep-Alive`：连接的方式
  - `Cache-Control: no-cache` 告知浏览器不要设置缓存
  - `Content-Disposition: attachment; filename=aaa.zip` 告知浏览器以下载方式打开数据
  - `Content-Encoding: gzip` 数据压缩的格式
  - `Content-Language: zh-cn` 服务器的语言环境
  - `Content-Length: 80` 回送数据的长度
  - `Content-Type: text/html; charset=GB2312` 回送数据的类型
  - `Date: Tue, 11 Jul 2000 18:23:51 GMT` 回送数据的时间（rfc822）
  - `Expires: -1` 告知浏览器不要设置缓存
  - `Last-Modified: Tue, 11 Jul 2000 18:23:51 GMT` 该资源上次更新的时间
  - `Location: http://www.it315.org/index.jsp` 要跳转到哪个页面
  - `Pragma: no-cache` 告知浏览器不要设置缓存
  - `Refresh: 1;url=http://www.it315.org` 需要浏览器定时刷新
  - `Server: apache tomcat` 服务器型号
  - `Set-Cookie:SS=Q0=5Lb_nQ; path=/search` 告知浏览器保存Cookie
  - `Transfer-Encoding: chunked` 告知浏览器以分块方式回送数据
- 空行
- 响应体 

### HTTP版本

HTTP1.0和HTTP1.1的区别：

- 1.0默认使用非持久连接；1.1默认使用持久连接，使多个http请求复用一个TCP连接
- 1.0存在带宽浪费，需要某对象的一部分时，会传送整个对象，且不支持断点续传；1.1可以只请求资源的某个部分
- 1.0主要使用If-Modified-Since、Expires作为缓存判断标准；1.1引入了更多的缓存控制策略
- 1.0不传递主机名（hostname）；1.1新增了host字段
- 1.1新增了PUT、HEAD、OPTIONS等请求方法



HTTP1.1和HTTP2.0的区别：待补充



HTTPS协议：超文本传输安全协议（Hypertext Transfer Protocol Secure）

- HTTP和HTTPS协议的区别：
  - HTTPS协议需要CA证书；HTTP不需要
  - HTTP协议是超文本传输协议，信息是明文传输的；HTTPS是具有安全性的SSL加密传输协议
  - HTTP的端口是80；HTTPS的端口是443
  - HTTP协议连接简单，没有状态；HTTPS协议可进行加密传输、身份认证，比HTTP更加安全
- HTTP协议的优点：简单快速、无连接、无状态、灵活【可传输任意类型的数据】
- HTTP协议的缺点：无状态、明文传输、不安全
- HTTPS优点：可以认证用户和服务器、可以加密传输、是现行架构下最安全的解决方案
- HTTPS缺点：加密和解密耗费资源、协议的握手阶段费时，增加页面加载时间、SSL证书收费、不能在同一IP绑定多个域名

## DNS协议

> 域名系统（Domain Name System），提供主机名到IP地址的转换服务
>
> DNS占用53号端口，同时使用TCP和UDP协议
>

完整查询过程：

- 首先会在浏览器的缓存中查找对应的IP地址，如果查找到直接返回，若找不到继续下一步
- 将请求发送给**本地DNS服务器**（hosts文件），在本地域名服务器缓存中查询，如果查找到，就直接将查找结果返回，若找不到继续下一步
- 本地DNS服务器向**根域名服务器**发送请求，根域名服务器会返回一个所查询域的顶级域名服务器地址
- 本地DNS服务器向**顶级域名服务器**发送请求，接受请求的服务器查询自己的缓存，如果有记录，就返回查询结果，如果没有就返回相关的下一级的权威域名服务器的地址
- 本地DNS服务器向**权威域名服务器**发送请求，域名服务器返回对应的结果
- 本地DNS服务器将返回结果保存在缓存中，便于下次使用
- 本地DNS服务器将返回结果返回给浏览器

## 网络模型

对等通信：模型的每一层都必须与目的端的对等层进行通信

OSI七层模型：自上而下分别为应用层、表示层、会话层、传输层、网络层、数据链路层、物理层

- 应用层：为用户提供应用接口和网络服务。
  - 应用层的网络服务协议有：HTTP、HTTPS、FTP（文件传输）、POP3、SMTP（邮件传输）等
- 表示层：提供各种应用层数据的编码和转换功能，确保一个系统的应用层发送的数据能被另一个系统的应用层识别。如：base64
- 会话层：负责建立、管理和终止表示层实体之间的通信会话
- 传输层：建立了主机端口到端口的链接，为上层协议提供端到端的数据传输服务（规定传输方式）。该层协议有：TCP、UDP
- 网络层：通过IP寻址来建立两个节点之间的连接，将分组从源端传输层正确地送到目的端的传输层（规定传输路线）。该层协议有：IP协议
- 数据链路层：将数据合成为帧，使用链路层地址（MAC地址）访问介质，并进行差错检测（传输路线）
- 物理层：通过物理介质传输比特流



TCP/IP五层协议：自上而下分别为应用层、传输层、网络层、数据链路层、物理层

- TCP/IP将OSI的应用层、表示层、会话层合并到了应用层，更简洁

## TCP与UDP协议

都是传输层协议，属于TCP/IP协议族

### UDP

用户数据报协议

特点：

- 面向无连接、有单播，多播，广播的功能
- 面向报文：仅对报文添加首部，不合并拆分
- 不可靠性：不需要建立连接，接收端不对报文进行确认
- 首部开销小：8字节，高效

头部包含：两个十六位端口号（源端口和目标端口）、整个数据报文的长度、整个数据报文的校验和

使用场景：效率要求高，准确性要求低，如QQ、网络语音电话、广播通信

### TCP

传输控制协议

特点：

- 面向连接、仅支持单播传输
- 面向字节流：不保留报文边界以字节流传输
- 可靠传输、有拥塞控制、提供全双工通信
- 首部开销大：最小20字节，最大60字节

使用场景：效率要求相对低，准确性要求高，如文件传输、远程登录

重传机制：发送数据后开启一个定时器，若没有收到ACK确认报文，则对报文进行重传

三次握手：建立一个TCP连接时，客户端和服务器总共需要发送3个包

## WebSocket

理解：是HTML5提供的一种浏览器与服务器进行全双工通讯的网络技术，属于应用层协议，基于TCP传输协议，并复用HTTP的握手通道。浏览器和服务器只需完成一次握手，两者之间就能创建持久性连接，进行双向数据传输

特点：支持双向通信、可以发送文本及二进制数据、建立在TCP协议上服务端实现容易、数据格式轻量性能开销小、没有同源限制、协议标识符为ws（加密则为wss），服务器网址为URL、与HTTP协议有良好兼容性，默认端口也为80和443

使用：见JavaScript笔记

## RestfulAPI

>  RESTful API就是REST风格的API，rest是一种架构风格，跟编程语言无关，跟平台无关。
>
> 常见误区：接口传递参数使用斜杠(/)分割而不用问号(?)传参



REST架构特征：通常使用HTTP做传输协议

- **以资源为基础** ：资源可以是一个图片、HTML格式或者JSON格式等网络上的一个实体。
- **URI指向资源**：URI包括URL和URN，在这里更多时候可能代指URL。RESTful是面向资源的，每种资源可能由一个或多个URI对应，但一个URI只指向一种资源。
- **统一接口**: 对资源的操作类型从其HTTP请求方法类型上进行判断：
  - GET（SELECT）：从服务器取出资源（一项或多项）
  - POST（CREATE）：在服务器新建一个资源
  - PUT（UPDATE）：在服务器更新资源（客户端提供完整资源数据）
  - PATCH（UPDATE）：在服务器更新资源（客户端提供需要修改的资源数据）
  - DELETE（DELETE）：从服务器删除资源
- **无状态**：指协议对于事务处理没有记忆能力。缺少状态意味着如果后续处理需要前面的信息，则它必须重传，这样可能导致每次连接传送的数据量增大。另一方面，在服务器不需要先前信息时它的应答就较快。



REST架构限制条件：

- **客户端-服务端（Client-Server）**: 客户端和服务端的分离，服务端独立可更好服务于前端、安卓、IOS等客户端设备。
- **无状态（Stateless）**：服务端不保存客户端状态，客户端保存状态信息每次请求携带状态信息。
- **可缓存性（Cacheability）** ：服务端需回复是否可以缓存以让客户端甄别是否缓存提高效率。
- **统一接口（Uniform Interface）**：通过一定原则设计接口降低耦合，简化系统架构，这是RESTful设计的基本出发点。
- **分层系统（Layered System）**：客户端无法直接知道连接的到终端还是中间设备，分层允许你灵活的部署服务端项目。
- **按需代码（Code-On-Demand，可选）**：按需代码允许我们灵活的发送一些看似特殊的代码给客户端例如JavaScript代码。