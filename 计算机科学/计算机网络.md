# 计算机网络

## 引入

从浏览器输入URL到看见页面发生了什么：

1. 解析URL并生成HTTP请求
2. DNS域名解析
3. 委托协议栈发送消息
4. 发起TCP连接（三次握手）
5. HTTP发起请求
6. 服务器处理请求
7. 渲染页面：构建DOM树
8. 关闭TCP连接（四次挥手）

客户端与服务端的即时通讯：

- 短轮询：浏览器每隔一段时间向服务端发送http请求，若有数据更新，则响应。严重浪费资源
- 长轮询：客户端向服务端发送请求，服务端不直接进行响应，将请求挂起，有更新再响应。仍然造成资源浪费
- SSE：基于http协议，服务器向客户端声明，发送流信息，节约了资源
- WebSocket：允许双向通信

## 互联网

### 互联网概述

- 端系统：位于互联网的边缘的系统，包括计算机、服务器、移动计算机等。端系统也称为主机（host），主机又可进一步划分为客户端（client）和服务器（server）。
- 接入网：将端系统物理连接到其边缘路由器的网络。其类型有DSL、以太网线路、光纤、WIFI、3G网络、卫星等。
  - 边缘路由器：端系统到任何其他远程端系统的路径上的第一台路由器
- ISP：网络服务提供商
  - 接入ISP：端系统通过一个接入ISP与互联网相连，可以是大学、公司、电信局等
  - 全球传输ISP：一个假想概念，作为媒介与所有接入ISP连接，以使得所有接入ISP之间互联
  - 第一层ISP：接近全球传输ISP的概念，第一层ISP有大约十几个，位于等级结构的顶部
  - 区域ISP：与一个区域的接入ISP连接，同时连接第一层ISP
  - 多宿（multi-home）：可以同时与多个ISP连接，某个ISP发生故障时，仍能正常使用网络，除第一层外的所有ISP可以选择多宿
  - 对等（peer）：等级结构层次相近的ISP能够对等，即直接将他们的网络连接到一起，无需通过上游的ISP传输。
  - IXP（Internet Exchange Point）：互联网交换点，一个汇合点，多个ISP能够在此对等
- 物理媒体：以电磁波或光脉冲的方式来发送比特的媒介。可分为导引型媒体和非导引型媒体。
  - 导引型媒体：电波沿固体媒体前行，如光纤等
  - 非导引型媒体：电波在空气或外层空间中传播，如无线局域网等
- 协议（protocol）：定义了在两个或多个通信实体之间交换的报文的格式和顺序，以及报文发送和/或接收一条报文或其他事件所采取的动作。
  - 报文（message）：包含协议设计者需要的任何东西，可以是控制功能（如握手报文）或数据
  - 分组（packet）：传输过程中将长报文分为较小数据块，即分组
- 分组交换：在源和目的地之间，每个分组都通过通信链路和分组交换机传送。
  - 交换机主要有两类：路由器（router）和链路层交换机（link-layer switch），链路层交换机实现了物理层和链路层，而路由器实现了物理层、链路层和网络层
  - 存储转发传输：多数交换机在输入端使用存储转发传输，指交换机需首先完整接收一个分组，才会开始向目的地转发该分组。
  - 输出缓存：分组发送的目标链路阻塞时，该分组必须在交换机的输出缓存中等待。若缓存满了，则该分组可能被丢弃，导致分组丢失（丢包）
  - 转发表：为了确定分组应向哪条链路转发，每台路由器具有一个转发表（forwarding table），用于将目标IP地址（或地址的一部分）映射成输出链路。
  - 路由选择协议：用于自动设置转发表
  - 节点时延：分组从一个节点（主机或路由器）传递到另一个节点的时延，包括处理时延（分析分组）、排队时延（在缓存等待）、传输时延（路由器推出分组）、传播时延（在链路传播）等
  - 端到端时延：从源到目的地的总时延，是由节点时延累加的时延
- 电路交换：通过网络链路和交换机移动数据有两种基本方法：电路交换和分组交换。电路交换网络中，端系统通信会话会预留通信所需的资源（缓存，链路速率等），在网络连通之前，两个端系统之间必须建立一条连接，随后进行通信，类似于传统的电话网络。由于分组交换提供了更好的带宽共享、实现更简单，所以电路交换逐渐被分组交换取代。



### 协议分层

> 以分层的方式组织协议以及实现这些协议的网络硬件和软件，可以降低耦合性，具有概念化和结构化的优点。但也可能出现冗余较低层的功能，例如，许多协议栈在基于每段链路和基于端到端两种情况下，都提供了差错恢复。第二种潜在的缺点是某层的功能可能需要仅在其他某层才出现的信息（如时间戳值），这违反了层次分离的目标
>
> 对于每个分层：①在这层中执行了某些动作；②使用直接下层的服务
>
> 协议栈：各层的所有协议被称为协议栈
>
> 对等通信：模型的每一层都必须与目的端的对等层进行通信

TCP/IP五层协议栈：自上而下分别为

- 应用层：为用户提供应用接口和网络服务，应用层的信息分组称为报文（message）
  - 协议有：HTTP、FTP（文件传输）、POP3、SMTP（邮件传输）、DNS等
- 传输层：用于在应用程序端点之间传送应用层报文，运输层的分组称为报文段（segment）
  - 协议有：TCP、UDP
- 网络层：通过IP寻址来建立两个节点之间的连接，传输分组，网络层传输的分组称为数据报（datagram）
  - 协议有：IP协议（Internet Protocol，网际协议）
- 链路层：将网络层下传的数据报传递给下一个节点。在该下一个节点，链路层将数据报上传给网络层，链路层的分组称为帧（frame）
  - 协议有：以太网、WIFI、电缆接入网的DOCSIS协议。
  - 一个数据报可能经由多条链路，并被多种不同的协议处理。
- 物理层：通过物理介质，将帧从一个网络元素移动到另一个网络元素



OSI七层模型：自上而下分别为应用层、表示层、会话层、传输层、网络层、数据链路层、物理层

- 表示层：使通信的应用程序能够解释交换数据的含义。这些服务包括数据压缩、数据加密以及数据描述
- 会话层：提供了数据交换的定界和同步功能，包括了建立检查点和恢复方案的方法
- OSI模型在互联网未出现时就成形了，现在通常使用TCP/IP五层协议栈，它将表示层和会话层合并至应用层中，更加简化。



基于TCP/IP协议栈的封装：

1. 在发送主机端，一个应用层报文被传送给运输层
2. 在最简单的情况下，传输层收取到报文并附上首部信息，该首部将被接收端的运输层使用。应用层报文和运输层首部信息一道构成了运输层报文段，运输层报文段因此封装了应用层报文。附加的信息也许包括了下列信息：允许接收端运输层向上向适当的应用程序交付报文的信息；差错检测位信息，该信息让接收方能够判断报文中的比特是否在途中已被改变。
   - 实际情况会更复杂，例如，大报文可能被划分为多个报文段，在接收端再重构报文。
3. 运输层则向网络层传递该报文段，网络层增加了如源和目的端系统地址等网络层首部信息，生成了网络层数 据报。
4. 该数据报接下来被传递给链路层，链路层增加它自己的链路层首部信息并生成链路层帧。
5. 在每一层，一个分组具有两种类型的字段：首部字段和有效载荷字段。有效载荷通常是来自上一层的分组。



### 网络攻击

- 僵尸网络（botnet）：受害主机可能称为僵尸网络的一员，用于攻击其他主机
- 病毒（virus）：需要某种形式的用户交互来感染用户设备的恶意软件。如：包含恶意可执行代码的电子邮件附件
- 蠕虫（worm）：无需明显用户交互就能进入设备的恶意软件，如：一个网络程序，能够从网络接收恶意软件并运行
- 拒绝服务攻击（Denial-of-Service（Dos） attack）：使得网络、主机或其他技术设施部分不能由合法用户使用，常见的Dos攻击类型有：
  - 弱点攻击：这涉及向一台目标主机上运行的易受攻击的应用程序或操作系统发送制作精细的报文。如果适当顺序的多个分组发送给一个易受攻击的应用程序或操作系统，该服务器可能停止运行，或者更糟糕的是主机可能崩溃
  - 带宽洪泛：攻击者向目标主机发送大量的分组，分组数量之多使得目标的接入链路变得拥塞，使得合法的分组无法到达服务器。
    - 分布式DoS攻击（Distributed DoS，DDoS）：攻击者控制多个源发起大量分组，DDoS相比单一主机的DoS更难防范和检测
  - 连接洪泛：攻击者在目标主机中创建大量的半开或全开TCP连接。该主机因这些伪造的连接而陷入困境，并停止接受合法的连接
- 分组嗅探器：使用WIFI和有线的广播环境中，可以接入分组嗅探器，记录每个流经的分组副本，以获取敏感信息。分组嗅探难以检测，需要通过加密来防御。
- IP哄骗：将虚假源地址的分组注入互联网，以冒充用户。可以通过端点鉴别防范

## 基本概念

### URL

统一资源定位符。

标准格式：`protocol://[userinfo@]host[:port][/path][?query][#fragment]`

- protocol：通信协议
- userinfo：格式为`user:password`，已弃用
- host：主机（域名）
- port：端口号，http默认端口为80，https默认为443
- path：路径，由任意个/分隔，开头的/表示根目录
  - 不以 / 结尾，会先将路径当做指向文件处理，若找不到该文件。再将路径当做指向目录处理
  - 以 / 结尾，表示访问该目录下的默认文件【一般为index.html或default.htm】
  - 路径省略不写，表示访问根目录下的默认文件
- query：参数，键值对形式，`?参数1=值1&参数2=值2`
- fragment：锚点，#开始到最后，常见于链接锚点

### 同源策略

> 两个URL协议、主机（域名）、端口号必须完全相同。违背同源策略就是跨域，默认禁止跨域读写。跨域是浏览器拦截了返回数据，而非服务器

跨域解决方案：

- JSONP：非官方的跨域解决方案，利用script标签可跨域访问脚本的特性，只支持get请求。
  1. 创建自定义函数，用于处理返回的数据
  2. 动态创建一个script标签，设置src属性为接口地址，并附上callback参数，值为自定义函数名
  3. 服务端将数据传入自定义函数的参数
  4. 前端的该函数会被调用，其参数来自服务端
- CORS：官方的跨域解决方案，支持get和post
  - 设置响应头`Access-Control-Allow-Origin` 值为 `*`
    - 值为允许的域名，*表示所有网页
- 代理服务器

## 协议

### HTTP协议

> HTTP协议，hypertext transport protocol，超文本传输协议，规定了浏览器和万维网服务器之间互相通信的规则约定

#### 状态码

- `1**`：信息，服务器收到请求，需要请求者继续执行操作
- `2**`：成功，操作被成功接收并处理
  - `200`：OK
- `3**`：重定向，需要进一步的操作以完成请求
  - `301`：请求的资源被永久移动到新的URI
  - `302`：临时移动
  - `303`：查看其他地址
  - `304`：所请求的资源未修改，服务器返回此状态码时，不会返回任何资源，浏览器会使用缓存
  - `307`：临时重定向
- `4**`：客户端错误，请求包含语法错误或无法完成请求
  - `400`：客户端请求语法错误
  - `401`：要求用户的身份认证
  - `403`：服务器拒绝请求
  - `404`：服务器无法找到资源
  - `408`：服务端等待客户端发送的请求时间过长，超时
- `5**`：服务端错误，服务器在处理请求的过程中发生了错误
  - `500`：服务器内部错误，无法完成请求
  - `501`：服务器不支持请求的功能
  - `502`：网关或代理服务器尝试执行请求时，从远程服务器接收到了一个无效响应

#### 请求

请求报文：

- 请求行：格式为`"请求方法 URL 协议版本 换行符"`
- 请求头：键值对形式，说明请求体类型。常用的请求头有：
  - `Accept: text/html,image/*`：浏览器能处理的内容类型
  - `Accept-Charset: ISO-8859-1`：浏览器能显示的字符集
  - `Accept-Encoding: gzip,compress`：浏览器能处理的压缩编码
  - `Accept-Language: en-us,zh-cn`：浏览器的语言环境
  - `Connection: close/Keep-Alive`：请求完成后断开还是保持连接
  - `Cookie`：当前页面设置的任何Cookie
  - `Date: Tue, 11 Jul 2000 18:23:51 GMT` 请求的时间
  - `Host: www.it315.org:80`：浏览器需要访问的主机
  - `Referer: http://www.it315.org/index.jsp`：客户机是从那个页面来的（反盗链）
  - `User-Agent: Mozilla/4.0 (compatible; MSIE 5.5; Windows NT 5.0)`：浏览器内核
  - `If-Modified-Since: Tue, 11 Jul 2000 18:23:51 GMT` 缓存数据的事件
- 空行
- 请求体

传递参数：

- url直接传递（GET请求）：在url的query参数中传递
- 请求体传递（POST请求）：将参数放入请求体中

常见的请求方法：

- GET：向服务器获取数据
- POST：将实体提交到指定资源
  - GET请求与POST请求的区别：
    - GET请求是一个幂等（多次操作是否对结果没有影响）的请求，POST请求不是
    - 浏览器一般会对GET请求缓存，但一般不对POST请求缓存
    - GET请求的请求体一般为空，POST请求的请求体一般为向服务器发送的数据
    - GET请求把参数放入url传递，POST可将参数放入请求体。GET更快，POST更安全
    - GET提交的参数受限于url长度；POST可以提交大量数据，支持更多的数据类型，受服务器限制
- PUT：上传文件，更新数据
- DELETE：删除服务器上的对象
- HEAD：获取报文首部，相比GET不返回报文主体部分
- OPTIONS：询问支持的请求方法，检查访问权限，如跨域权限
- CONNECT：要求在与代理服务器通信时建立隧道，使用隧道进行TCP通信
- TRACE：回显服务器收到的请求，用于测试或诊断



GET安全且幂等读取服务器内容时使用变更时获取表示（缓存）POST不安全且不幂等使用服务端管理的（自动产生）的实例号创建资源创建子资源部分更新资源如果没有被修改，则不更新资源（乐观锁）PUT不安全但幂等用客户端管理的实例号创建一个资源通过替换的方式更新资源如果未被修改，则更新资源（乐观锁）DELETE不安全但幂等删除资源HEAD安全且幂等递交获取资源的元数据OPTIONS安全且幂等获取信息，关于资源的哪些属性是客户端可以改变的。PATCH不安全，可以是不幂等的局部更新资源与PUT区别：只更新少部分内容；可能根据原数据进行变化（比如基本工资加200元），这时就不幂等了。



#### 响应

响应报文：

- 响应行：`"协议版本 状态码 状态码原因短语"`
- 响应头：键值对形式，对响应体的描述，常用的响应头有：
  - `Connection: close/Keep-Alive`：连接的方式
  - `Cache-Control: no-cache` 告知浏览器不要设置缓存
  - `Content-Disposition: attachment; filename=aaa.zip` 告知浏览器以下载方式打开数据
  - `Content-Encoding: gzip` 数据压缩的格式
  - `Content-Language: zh-cn` 服务器的语言环境
  - `Content-Length: 80` 回送数据的长度
  - `Content-Type: text/html; charset=GB2312` 回送数据的类型
  - `Date: Tue, 11 Jul 2000 18:23:51 GMT` 回送数据的时间（rfc822）
  - `Expires: -1` 告知浏览器不要设置缓存
  - `Last-Modified: Tue, 11 Jul 2000 18:23:51 GMT` 该资源上次更新的时间
  - `Location: http://www.it315.org/index.jsp` 要跳转到哪个页面
  - `Pragma: no-cache` 告知浏览器不要设置缓存
  - `Refresh: 1;url=http://www.it315.org` 需要浏览器定时刷新
  - `Server: apache tomcat` 服务器型号
  - `Set-Cookie:SS=Q0=5Lb_nQ; path=/search` 告知浏览器保存Cookie
  - `Transfer-Encoding: chunked` 告知浏览器以分块方式回送数据
- 空行
- 响应体 

#### HTTP版本

HTTP1.0和HTTP1.1的区别：

- 1.0默认使用非持久连接；1.1默认使用持久连接，使多个http请求复用一个TCP连接
- 1.0存在带宽浪费，需要某对象的一部分时，会传送整个对象，且不支持断点续传；1.1可以只请求资源的某个部分
- 1.0主要使用If-Modified-Since、Expires作为缓存判断标准；1.1引入了更多的缓存控制策略
- 1.0不传递主机名（hostname）；1.1新增了host字段
- 1.1新增了PUT、HEAD、OPTIONS等请求方法



HTTP1.1和HTTP2.0的区别：待补充



HTTPS协议：超文本传输安全协议（Hypertext Transfer Protocol Secure）

- HTTP和HTTPS协议的区别：
  - HTTPS协议需要CA证书；HTTP不需要
  - HTTP协议是超文本传输协议，信息是明文传输的；HTTPS是具有安全性的SSL加密传输协议
  - HTTP的端口是80；HTTPS的端口是443
  - HTTP协议连接简单，没有状态；HTTPS协议可进行加密传输、身份认证，比HTTP更加安全
- HTTP协议的优点：简单快速、无连接、无状态、灵活【可传输任意类型的数据】
- HTTP协议的缺点：无状态、明文传输、不安全
- HTTPS优点：可以认证用户和服务器、可以加密传输、是现行架构下最安全的解决方案
- HTTPS缺点：加密和解密耗费资源、协议的握手阶段费时，增加页面加载时间、SSL证书收费、不能在同一IP绑定多个域名

### DNS协议

> 域名系统（Domain Name System），提供主机名到IP地址的转换服务
>
> DNS占用53号端口，同时使用TCP和UDP协议
>

完整查询过程：

- 首先会在浏览器的缓存中查找对应的IP地址，如果查找到直接返回，若找不到继续下一步
- 将请求发送给**本地DNS服务器**（hosts文件），在本地域名服务器缓存中查询，如果查找到，就直接将查找结果返回，若找不到继续下一步
- 本地DNS服务器向**根域名服务器**发送请求，根域名服务器会返回一个所查询域的顶级域名服务器地址
- 本地DNS服务器向**顶级域名服务器**发送请求，接受请求的服务器查询自己的缓存，如果有记录，就返回查询结果，如果没有就返回相关的下一级的权威域名服务器的地址
- 本地DNS服务器向**权威域名服务器**发送请求，域名服务器返回对应的结果
- 本地DNS服务器将返回结果保存在缓存中，便于下次使用
- 本地DNS服务器将返回结果返回给浏览器

### TCP与UDP协议

都是传输层协议，属于TCP/IP协议族

#### UDP

用户数据报协议

特点：

- 面向无连接、有单播，多播，广播的功能
- 面向报文：仅对报文添加首部，不合并拆分
- 不可靠性：不需要建立连接，接收端不对报文进行确认
- 首部开销小：8字节，高效

头部包含：两个十六位端口号（源端口和目标端口）、整个数据报文的长度、整个数据报文的校验和

使用场景：效率要求高，准确性要求低，如QQ、网络语音电话、广播通信

#### TCP

传输控制协议

特点：

- 面向连接、仅支持单播传输
- 面向字节流：不保留报文边界以字节流传输
- 可靠传输、有拥塞控制、提供全双工通信
- 首部开销大：最小20字节，最大60字节

使用场景：效率要求相对低，准确性要求高，如文件传输、远程登录

重传机制：发送数据后开启一个定时器，若没有收到ACK确认报文，则对报文进行重传

三次握手：建立一个TCP连接时，客户端和服务器总共需要发送3个包

## WebSocket

理解：是HTML5提供的一种浏览器与服务器进行全双工通讯的网络技术，属于应用层协议，基于TCP传输协议，并复用HTTP的握手通道。浏览器和服务器只需完成一次握手，两者之间就能创建持久性连接，进行双向数据传输

特点：支持双向通信、可以发送文本及二进制数据、建立在TCP协议上服务端实现容易、数据格式轻量性能开销小、没有同源限制、协议标识符为ws（加密则为wss），服务器网址为URL、与HTTP协议有良好兼容性，默认端口也为80和443

使用：见JavaScript笔记

## RestfulAPI

>  RESTful API就是REST风格的API，rest是一种架构风格，跟编程语言无关，跟平台无关。
>
> 常见误区：认为 Restful 就是接口传递参数使用 斜杠(/)分割 而不用 query(?) 传参，其实这两种方式均是可以采用的



REST架构特征：通常使用HTTP做传输协议

- **以资源为基础** ：资源可以是一个图片、HTML格式或者JSON格式等网络上的一个实体。
- **URI指向资源**：URI包括URL和URN，在这里更多时候可能代指URL。RESTful是面向资源的，每种资源可能由一个或多个URI对应，但一个URI只指向一种资源。
- **统一接口**: 对资源的操作类型从其HTTP请求方法类型上进行判断：
  - GET（SELECT）：从服务器取出资源（一项或多项）
  - POST（CREATE）：在服务器新建一个资源
  - PUT（UPDATE）：在服务器更新资源（客户端提供完整资源数据）
  - PATCH（UPDATE）：在服务器更新资源（客户端提供需要修改的资源数据）
  - DELETE（DELETE）：从服务器删除资源
- **无状态**：指协议对于事务处理没有记忆能力。缺少状态意味着如果后续处理需要前面的信息，则它必须重传，这样可能导致每次连接传送的数据量增大。另一方面，在服务器不需要先前信息时它的应答就较快。



REST架构限制条件：

- **客户端-服务端（Client-Server）**: 客户端和服务端的分离，服务端独立可更好服务于前端、安卓、IOS等客户端设备。
- **无状态（Stateless）**：服务端不保存客户端状态，客户端保存状态信息每次请求携带状态信息。
- **可缓存性（Cacheability）** ：服务端需回复是否可以缓存以让客户端甄别是否缓存提高效率。
- **统一接口（Uniform Interface）**：通过一定原则设计接口降低耦合，简化系统架构，这是RESTful设计的基本出发点。
- **分层系统（Layered System）**：客户端无法直接知道连接的到终端还是中间设备，分层允许你灵活的部署服务端项目。
- **按需代码（Code-On-Demand，可选）**：按需代码允许我们灵活的发送一些看似特殊的代码给客户端例如JavaScript代码。